name: E2E Replication Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  e2e:
    name: P2P Replication E2E
    runs-on: [self-hosted, cordelia-docker]
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build node image
        run: docker build -t cordelia-node:test -f tests/e2e/Dockerfile.test .

      - name: Build orchestrator image
        run: docker build --no-cache -t cordelia-orchestrator -f tests/e2e/Dockerfile.orchestrator tests/e2e/

      - name: Generate CI topology
        run: |
          cp tests/e2e/topology-ci.env tests/e2e/topology.env
          bash tests/e2e/gen-compose-zoned.sh

      - name: Start cluster
        run: docker compose -f tests/e2e/docker-compose.generated.yml up -d --wait
        timeout-minutes: 3

      - name: Wait for mesh convergence
        run: |
          echo "Waiting 20s for P2P mesh to stabilize..."
          sleep 20

      - name: Verify orchestrator has latest code
        run: |
          docker exec cordelia-e2e-orchestrator grep -c 'set +e' /tests/ci-smoke-test.sh || echo "WARNING: set +e not found!"
          docker exec cordelia-e2e-orchestrator head -5 /tests/ci-smoke-test.sh

      - name: Run CI smoke tests
        run: |
          docker exec -e REPORT=1 cordelia-e2e-orchestrator bash -x /tests/ci-smoke-test.sh

      - name: Collect reports
        if: always()
        run: |
          mkdir -p reports
          docker cp cordelia-e2e-orchestrator:/tests/reports/ reports/ 2>/dev/null || true

      - name: Upload report artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: e2e-reports
          path: reports/
          retention-days: 30

      - name: Teardown
        if: always()
        run: |
          docker compose -f tests/e2e/docker-compose.generated.yml down -v --remove-orphans 2>/dev/null || true
          docker image prune -f 2>/dev/null || true
